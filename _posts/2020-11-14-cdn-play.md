---
layout:     post
title:      "CDN Play: Eason"
tags:
    - CDN

---
# CDN Play: Eason

## **ç®€ä»‹**

CDN content delivery network, å­—é¢ç¿»è¯‘ï¼šå†…å®¹åˆ†å‘ç½‘ç»œï¼Œå®ƒåˆ©ç”¨éƒ¨ç½²åœ¨å„åœ°çš„æœåŠ¡å™¨æ„å»ºä¸€ä¸ªç½‘ç»œå¹³å°ä½¿ç”¨GSLBæŠ€æœ¯å¼•å¯¼ç”¨æˆ·å»è®¿é—®æœ€ä½³çš„èŠ‚ç‚¹ï¼ˆé€šå¸¸ä¸ºæœ€è¿‘ï¼‰ï¼Œ
è€Œè¿™ä¸ªèŠ‚ç‚¹çš„CACHEæœåŠ¡ç”±äºç¼“å­˜äº†è¯·æ±‚çš„å†…å®¹ï¼Œä»è€Œä½¿å¾—ç”¨æˆ·è®¿é—®å“åº”åŠ å¿«ï¼Œä¹Ÿå‡è½»æºç«™çš„è´Ÿè½½ã€‚å‰é¢çš„ä¸ŠåŠå¥è¯å¯¹åº”CDNçš„æ§åˆ¶å¹³é¢, è€ŒååŠå¥åˆ™æ˜¯æ•°æ®å¹³é¢ï¼Œå‚è€ƒä¹‹å‰çš„ä»‹ç»è¿‡çš„[Traffic Control Introduction](https://europelee.github.io/2019/06/22/Traffic-Control-Intro/)ã€‚
è¿™ç¯‡æ–‡ç« çš„ç›®çš„æ˜¯æ›´å¤šçš„ä»å®æ“è§’åº¦è®©è¯»è€…ï¼ŒåŒ…æ‹¬æˆ‘æ›´å¥½çš„ç†è§£CDNå†…éƒ¨è¿ä½œåŸç†ã€‚åŒæ—¶ä»[CDNç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Content_delivery_network)ä½œä¸º
å»¶ä¼¸CDNäº†è§£çš„å…¥å£ç‚¹ã€‚

## **åœºæ™¯**

ä»[namesilo](https://www.namesilo.com)ä¹°äº†åŸŸåabc.site(å‡çš„ğŸ˜„)ï¼Œå¤‡æ¡ˆå¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±åœ¨æŸäº‘ä¸Šè´­ä¹°é¦™æ¸¯äº‘ä¸»æœºç”¨æ¥å»ºç½‘ç«™ï¼Œç«™ç‚¹åŸŸåä½¿ç”¨www.abc.siteã€‚ä½†æ˜¯
å¦‚æœç½‘ç«™çš„ç”¨æˆ·å¤§å¤šæ•°æ˜¯å¤§é™†å¢ƒå†…ï¼Œåˆæœ‰æ–°çš„é—®é¢˜ï¼Œç”±äºä¼—æ‰€å‘¨çŸ¥çš„GFW, å¤©æœPæ°‘è®¿é—®å¤§é™†å¢ƒå¤–ç½‘ç»œï¼Œä¼šæ—¶ä¸æ—¶çš„è¢«è°ƒæˆä¸€ä¸‹ã€‚è¿™æ—¶å€™å°±è¯¥CDNä¸Šåœºäº†ï¼Œä¸ºäº†ä¸æŠ½é£ï¼Œæˆ‘ä»¬åˆåœ¨æŸäº‘ä¸Šè´­ä¹°äº†ä¸€ä¸ª
ä¸Šæµ·çš„äº‘ä¸»æœºä½œä¸ºåŠ é€ŸèŠ‚ç‚¹ã€‚
æ„æˆCDNä¸»è¦ç”±ä¸¤ä¸ªç³»ç»Ÿç»„æˆï¼šGSLBå’ŒCACHE, GSLBé€šå¸¸æ˜¯ä½¿ç”¨æ‰€è°“çš„æ™ºèƒ½DNSå®ç°ï¼Œè€ŒCACHEä½¿ç”¨ç¼“å­˜ä»£ç†è½¯ä»¶ã€‚æœ¬ç¯‡æ–‡ç« ä½¿ç”¨[PowerDNS](https://www.powerdns.com)å’Œ[Apache Traffic Server](https://trafficserver.apache.org)æ¥æ¼”ç¤ºã€‚

![img](/img/cdnplay.png)

## **å®æ“**

### **éƒ¨ç½²pdns**

1. å‚è€ƒå®˜æ–¹[é“¾æ¥](https://repo.powerdns.com), å®‰è£…pdnsæˆæƒå™¨(å…³äºdnsé€’å½’å™¨å’Œæˆæƒå™¨çš„å®šä¹‰ï¼Œå¤§å®¶è‡ªè¡Œgoogle)

    ```text
    yum install epel-release yum-plugin-priorities -y && curl -o /etc/yum.repos.d/powerdns-auth-44.repo https://repo.powerdns.com/repo-files/centos-auth-44.repo && yum install pdns -y
    ```

2. å®‰è£…pdnsæˆæƒå™¨ geoæ’ä»¶(i.e æ‰€è°“åˆçº§æ™ºèƒ½dns feature)

    ```text
    yum install  pdns-backend-geoip -y
    ```

3. å®‰è£…pdns-backend-geoipéœ€è¦çš„åœ°ç†åº“

   * æˆ‘ä»¬éœ€è¦åˆ°[maxmind](https://www.maxmind.com)æ³¨å†Œï¼Œè·å–License key

   * åœ¨éƒ¨ç½²çš„æœºå™¨ä¸Šå®‰è£…[geoipupdate](https://github.com/maxmind/geoipupdate)ï¼Œç”¨äºä¸‹è½½åœ°ç†åº“æ–‡ä»¶,
   ç¼–è¾‘/usr/local/etc/GeoIP.confæ–‡ä»¶,ä¸»è¦æ·»åŠ 3é¡¹ï¼Œå¦‚ä¸‹æ‰€ç¤º, æœ€åæ‰§è¡Œ geoipupdate -v ä¸‹è½½GeoLite2-City.mmdb  GeoLite2-Country.mmdb

      ```text
      AccountID <your_id>
      LicenseKey <your_license_key_from_maxmind>
      EditionIDs GeoLite2-Country GeoLite2-City
      ```

4. é…ç½®pdns-backend-geoip

    * ä¿®æ”¹pdns.conf

        ```text
        include-dir=/etc/pdns/pdns.d
        ```

    * åˆ›å»º/etc/pdns/pdns.d/geoip.conf

        ```text
        launch=geoip
        geoip-database-files=/usr/local/share/GeoIP/GeoLite2-City.mmdb /usr/local/share/GeoIP/GeoLite2-Country.mmdb
        geoip-zones-file=/usr/local/share/zone.yaml
        edns-subnet-processing=true
        ```

    * é…ç½®geoip-zones /usr/local/share/zone.yaml, [refer](https://doc.powerdns.com/authoritative/backends/geoip.html#geoip-zones-file)

      ```yaml
      domains:
      - domain: abc.site
        ttl: 30
        records:
          abc.site:
            - soa: ns1.abc.site hostmaster.abc.site 2014090125 7200 3600 1209600 3600
            - ns:
                content: ns1.abc.site
                ttl: 60
            - ns: ns2.abc.site
            - mx: 10 mx.abc.site
            - txt: "your ip is %ip"
          ns1.abc.site:
            - a:
                content: <your_hk_ip>
                ttl: 86400
          ns2.abc.site:
            - a:
                content: <your_shanghai_ip>
                ttl: 86400
          unknown.unknown.geo.abc.site:
            - a: <your_hk_ip>
          unknown.as.geo.abc.site:
            - a: <your_hk_ip>
          cn.as.geo.abc.site:
            - a: <your_shanghai_ip>
        services:
          www.abc.site:
            default: ['%co.%cn.geo.abc.site', 'unknown.%cn.geo.abc.site', 'unknown.unknown.geo.abc.site']
      ```

5. systemctl start pdns  

åœ¨ä½ çš„hk, shanghaiäº‘ä¸»æœºä¸ŠæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤è¿›è¡Œpdnséƒ¨ç½²ï¼Œä¹‹ååˆ°[namesilo](https://www.namesilo.com)ä¿®æ”¹ç«™ç‚¹åŸŸåwww.abc.siteçš„nsæˆæƒå™¨ä¸ºä½ è‡ªå»ºçš„ns1.abc.site, ns2.abc.site.

### **éƒ¨ç½²traffic server**

ç›´æ¥å‚è€ƒ[è¿™é‡Œ](#jump_install_ats)

### **é™æ€ç½‘ç«™**

ç”¨nginxåœ¨ä½ çš„hkäº‘ä¸»æœºä¸Šéƒ¨ç½²ä¸€ä¸ªé™æ€ç½‘ç«™, é…ç½®server_name  www.abc.site.

## **éªŒè¯**

ä½¿ç”¨[ç«™é•¿å·¥å…·](http://tool.chinaz.com), æµè§ˆå™¨è¾“å…¥ <http://ping.chinaz.com/www.abc.site>, æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºå›½å†…èŠ‚ç‚¹è¾“å‡ºçš„å“åº”IPæ˜¯<your_shanghai_ip>,
è€Œæµ·å¤–èŠ‚ç‚¹è¾“å‡ºçš„å“åº”IPæ˜¯<your_hk_ip>, ä¸ªåˆ«èŠ‚ç‚¹å¯èƒ½æœ‰åå·®ï¼Œå› ä¸ºdnsä½¿ç”¨çš„åœ°ç†åº“å¹¶å‘100%å‡†ç¡®ã€‚  

è¿™æ ·æˆ‘ä»¬çš„æœ€åˆCDNè¯ç”Ÿäº†ï¼Œå®ƒçš„åå­—å«Eason.

## **å‚è€ƒ**

* [GeoDNS with the PowerDNS GeoIP back-end](https://jpmens.net/2015/11/12/geodns-with-powerdns-geoip-back-end/)
* [Building a DIY CDN: traffic distribution (with GeoDNS)](https://umbriel.fr/blog/Building_a_DIY_CDN:_traffic_distribution.html)
* <span id="jump_install_ats">[ä¸€é”®å®‰è£…é…ç½®é«˜æ€§èƒ½çš„CDNèŠ‚ç‚¹](https://qing.su/article/oneclick-cdn.html)</span>
* [è‡ªå»ºATS CDNç³»ç»Ÿ-Apache Traffic Serverä¸€é”®å®‰è£…é…ç½®é«˜æ€§èƒ½çš„CDNèŠ‚ç‚¹](https://wzfou.com/ats-cdn/)
* [è‡ªå»º PowerDNS æ™ºèƒ½è§£ææœåŠ¡å™¨](https://guozeyu.com/2016/08/self-host-dns/)
